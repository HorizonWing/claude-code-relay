# Fallback机制测试说明

## 实现概述

我已经成功为Claude Code Relay系统添加了完整的fallback机制，确保在同一个分组中当某个账号调用失败时能够自动切换到其他可用账号。

## 核心功能

### 1. 多账号重试逻辑
- **GetMessages函数**：修改了原有的单账号选择逻辑，现在会依次尝试分组中的所有可用账号
- **账号选择策略**：保持原有的优先级和使用次数排序，依次尝试直到成功或所有账号失败

### 2. 账号失败标记
- **自动状态更新**：当账号请求失败时，自动将其状态标记为异常状态（current_status = 2）
- **实时过滤**：失败账号在后续请求中会被自动过滤掉，避免重复尝试

### 3. 现有恢复机制
- **定时恢复检查**：系统每30分钟自动检查异常账号状态
- **自动恢复**：通过测试接口验证账号是否恢复正常，成功则重置状态为正常
- **限流恢复**：每10分钟检查限流过期的账号并恢复状态

## 实现细节

### 关键修改文件

1. **controller/claude_code.go**：
   - 修改GetMessages函数添加fallback逻辑
   - 新增executeWithFallback函数执行多账号重试
   - 新增markAccountAsFailed函数标记失败账号
   - 新增responseCapture结构捕获响应状态

2. **relay/claude.go**：
   - 添加新的账号状态常量（虽然最终没有使用新状态，但保留了扩展性）

### 工作流程

1. **请求到达**：
   ```
   客户端请求 → GetMessages → 查询分组账号 → 模型权限过滤 → 进入fallback流程
   ```

2. **Fallback流程**：
   ```
   遍历可用账号 → 尝试请求 → 检查状态码
   ├─ 成功：返回响应，结束流程
   └─ 失败：标记账号状态，继续下一个账号
   ```

3. **失败处理**：
   ```
   账号请求失败 → 更新current_status=2 → 记录日志 → 继续下一个账号
   ```

4. **账号恢复**：
   ```
   定时任务(30分钟) → 查询异常账号 → 测试接口 → 恢复正常状态
   ```

## 日志输出示例

### 成功Fallback的情况
```
🔄 尝试使用账号 [1/3]: account1 (平台: claude, 优先级: 1)
❌ 账号 account1 请求失败: HTTP 429: {"error": "rate_limit"}
🔄 切换到下一个账号进行重试...
🔄 尝试使用账号 [2/3]: account2 (平台: claude_console, 优先级: 1)
✅ 账号 account2 请求成功
```

### 所有账号失败的情况
```
🔄 尝试使用账号 [1/3]: account1 (平台: claude, 优先级: 1)
❌ 账号 account1 请求失败: HTTP 401: {"error": "unauthorized"}
🔄 切换到下一个账号进行重试...
🔄 尝试使用账号 [2/3]: account2 (平台: claude_console, 优先级: 1)
❌ 账号 account2 请求失败: HTTP 429: {"error": "rate_limit"}
🔄 切换到下一个账号进行重试...
🔄 尝试使用账号 [3/3]: account3 (平台: openai, 优先级: 2)
❌ 账号 account3 请求失败: HTTP 500: {"error": "internal_error"}
❌ 所有 3 个账号都请求失败，最后错误: {"error": "internal_error"}
```

## 测试建议

### 1. 模拟失败场景
- 暂时禁用某些账号的API密钥
- 使用达到限额的账号
- 测试网络连接失败的情况

### 2. 验证恢复机制
- 手动将账号状态设置为异常（current_status = 2）
- 等待30分钟观察自动恢复
- 或者手动触发定时任务测试

### 3. 性能测试
- 测试多账号同时失败时的响应时间
- 验证大量账号情况下的选择效率
- 测试高频请求下的账号状态管理

## 注意事项

1. **账号状态**：失败账号会被标记为current_status=2，在定时任务恢复前不会被使用
2. **恢复频率**：异常账号每30分钟检查一次，可修改scheduled/cron_main.go中的定时配置
3. **日志监控**：所有fallback操作都有详细日志，建议监控相关日志来观察系统运行状态
4. **数据库更新**：每次账号状态变更都会立即更新数据库，确保状态一致性

## 扩展性

1. **权重调整**：可以基于成功率动态调整账号权重
2. **智能选择**：可以根据历史成功率、响应时间等因素优化账号选择策略
3. **自定义策略**：可以通过配置文件定义不同的fallback策略
4. **监控指标**：可以添加更多监控指标来跟踪fallback机制的效果

这个fallback机制现在完全集成到现有系统中，保持了原有的架构设计原则，并提供了强大的容错能力。